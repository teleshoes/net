#!/usr/bin/perl
use strict;
use warnings;

my $devStatuses = {
  wlan => [qw(wlan)],
  eth  => [qw(eth)],
  ppp  => [qw(ppp)],
};
my $wconnect = 'wconnect';
my $wauto = 'wauto';
my $tethering = 'tethering';
my $none = 'none';

my $okStatuses = join ',', ($wauto, $tethering, $none, sort keys %$devStatuses);
my $usage = "Usage: $0  print one of [$okStatuses]\n";

sub getDev();
sub isWconnect();
sub isWauto();
sub isTethering();


sub main(@){
  die $usage if @_ > 0;
  my $status = getDev();
  $status = $wconnect if not defined $status and isWconnect();
  $status = $wauto if not defined $status and isWauto();
  $status = $tethering if not defined $status and isTethering();
  $status = $none if not defined $status;
  print "$status\n";
}

sub getDev(){
  my $netstat = `ifconfig -s`;

  for my $status(sort keys %$devStatuses){
    my @devs = @{$$devStatuses{$status}};
    my $device = `ifdev @devs 2>/dev/null`;
    chomp $device;
    if($? == 0 and $netstat =~ /^$device /m){
      if($status eq 'wlan'){
        my $iwconfig = `iwconfig $device`;
        if($iwconfig =~ /ESSID:off\/any\s*$/m){
          next;
        }
      }
      if(`ifconfig $device` =~ /inet( addr)? \d+/){
        return $status;
      }
    }
  }
  return undef;
}

sub isWconnect(){
  system "pgrep wconnect > /dev/null 2>/dev/null";
  return $? == 0;
}

sub isWauto(){
  system "pgrep wauto > /dev/null 2>/dev/null";
  return $? == 0;
}

sub isTethering(){
  system "pidof pppd wvdial > /dev/null 2>/dev/null";
  return $? == 0;
}

&main(@ARGV);
